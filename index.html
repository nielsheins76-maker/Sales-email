<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDS Email Assistant (Debug Version)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 2em; background-color: #f8f9fa; color: #212529; font-size: 14px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; padding: 2em; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5em; text-align: center; }
        
        /* Debug Box Styles */
        .debug-box {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
            font-size: 13px;
            text-align: left;
            white-space: pre-line;
        }
        .error-title { font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 5px; }

        /* Standard Styles */
        .file-upload-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .file-input-box { padding: 20px; border: 2px dashed #ced4da; border-radius: 8px; background-color: #f8f9fa; text-align: center; }
        input[type="file"] { width: 100%; padding: 8px; margin-top: 10px; }
        button { display: block; width: 100%; padding: 12px; font-size: 1em; font-weight: bold; cursor: pointer; color: white; border: none; border-radius: 5px; margin-top: 10px; }
        .button-disabled { background-color: #6c757d; cursor: not-allowed; }
        .button-ready { background-color: #28a745; }
        .button-primary { background-color: #007bff; }
        .button-primary:hover { background-color: #0056b3; }
        #results-container { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        th, td { border: 1px solid #dee2e6; text-align: left; padding: 8px; font-size: 12px; }
        th { background-color: #e9ecef; }
        .sds-match { color: #28a745; font-weight: bold; }
        .sds-no-match { color: #dc3545; }
        .footer { margin-top: 2em; text-align: center; color: #6c757d; font-size: 0.9em; }
        
        /* Search dropdown styles */
        .sds-search-container { position: relative; }
        .sds-search-container input { width: 100%; box-sizing: border-box; }
        .sds-results { display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background-color: white; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sds-results div { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 11px; color: #212529; }
        .sds-results div:hover { background-color: #e9ecef; }
    </style>
</head>
<body>

    <div class="container">
        <h1>SDS Email Assistant</h1>
        
        <!-- DIAGNOSTIC PANEL -->
        <div id="diagnostic-panel" class="debug-box">
            <strong>System Diagnostics:</strong><br>
            Current URL: <span id="current-url">Loading...</span><br>
            Protocol: <span id="current-protocol">Loading...</span><br>
            Status: <span id="env-status">Checking...</span>
        </div>

        <div id="auth-container">
            <button id="signInButton" onclick="signIn()" class="button-primary">Sign In with Microsoft</button>
            <button id="signOutButton" onclick="signOut()" class="button-primary" style="display: none;">Sign Out</button>
            <p id="auth-status" class="status"></p>
            <div id="auth-error-details" class="error-box"></div>
        </div>

        <div class="file-upload-area">
            <div class="file-input-box">
                <label for="ordersFile">1. Select Order History File</label>
                <input type="file" id="ordersFile" accept=".xls,.xlsx">
            </div>
            <div class="file-input-box">
                <label for="sdsFolder">2. Select SDS PDF Folder</label>
                <input type="file" id="sdsFolder" webkitdirectory directory multiple>
            </div>
        </div>

        <div id="search-container">
            <input type="text" id="searchInput" placeholder="Search by Customer PO...">
        </div>

        <button id="processButton" onclick="processFiles()" disabled class="button-disabled">Process Files</button>
        
        <div id="results-container"></div>
    </div>

    <div id="log-container" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #dee2e6;">
        <h2>Activity Log</h2>
        <div id="log-area" style="height: 150px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ced4da; padding: 10px; font-family: monospace;"></div>
    </div>

    <div class="footer">
        <p>ADDEV Materials Aerospace B.V.</p>
    </div>

    <script>
        // --- DIAGNOSTICS RUN ON LOAD ---
        window.onload = function() {
            const currentUrl = window.location.href;
            const protocol = window.location.protocol;
            document.getElementById('current-url').textContent = currentUrl;
            document.getElementById('current-protocol').textContent = protocol;

            const statusEl = document.getElementById('env-status');
            if (protocol === 'file:') {
                statusEl.innerHTML = "❌ CRITICAL ERROR: Running from file system. MSAL Authentication will NOT work. You must run this via a local server (http://localhost) or GitHub Pages (https://...).";
                statusEl.style.color = "red";
                statusEl.style.fontWeight = "bold";
                document.getElementById('signInButton').disabled = true;
                document.getElementById('signInButton').innerText = "Cannot Sign In (File Protocol)";
            } else if (protocol === 'http:' && !currentUrl.includes('localhost')) {
                statusEl.innerHTML = "⚠️ WARNING: Running on HTTP (Non-Secure). MSAL usually requires HTTPS unless on localhost.";
            } else {
                statusEl.innerHTML = "✅ Environment looks OK (HTTPS/Localhost). Check Azure Config next.";
                statusEl.style.color = "green";
            }
        };

        // --- MSAL CONFIGURATION ---
        // IMPORTANT: Verify these values against your Azure Portal
        const msalConfig = {
            auth: {
                clientId: "8526bd2d-d28b-46c2-8b26-69887f97e0bf",
                authority: "https://login.microsoftonline.com/3eb0a4e0-e392-46c7-82db-984db1de22f8", 
                redirectUri: "https://nielsheins76-maker.github.io/Sales-email/", 
            },
            cache: {
                cacheLocation: "sessionStorage", 
                storeAuthStateInCookie: false, 
            }
        };

        const graphScopes = ["user.read", "mail.send"];
        let myMSALObj;
        let accessToken = null;

        try {
            myMSALObj = new msal.PublicClientApplication(msalConfig);
        } catch (e) {
            showError("Initialization Error", e);
        }
        
        // --- AUTHENTICATION LOGIC ---
        async function signIn() {
            // Clear previous errors
            document.getElementById('auth-error-details').style.display = 'none';
            document.getElementById('auth-status').innerText = "Attempting login...";

            const loginRequest = { 
                scopes: graphScopes,
                prompt: "select_account" // Forces account selection to avoid stuck sessions
            };

            try {
                const loginResponse = await myMSALObj.loginPopup(loginRequest);
                handleResponse(loginResponse);
            } catch (error) {
                console.error("FULL LOGIN ERROR OBJECT:", error); // Check Console for this!
                
                let title = "Login Failed";
                let msg = error.message || JSON.stringify(error);
                let solution = "";

                // Analyze Error
                if (error.errorCode === "redirect_uri_mismatch" || msg.includes("AADSTS50011")) {
                    title = "Redirect URI Mismatch";
                    solution = `1. Go to Azure Portal > Authentication.\n2. Ensure this EXACT URL is added:\n   ${window.location.href}\n3. Watch out for trailing slashes ( / )!`;
                } else if (msg.includes("AADSTS50020")) {
                    title = "Tenant / Account Error";
                    solution = "You are signing in with a Personal account (Outlook/Hotmail) or an account from a different organization.\nThis app is locked to Tenant ID: 3eb0a4e0...";
                } else if (msg.includes("AADSTS7000218")) {
                    title = "Wrong Platform Config";
                    solution = "In Azure Portal > Authentication, ensure you added 'Single-page application' platform.\nDo NOT use 'Web' platform (it requires a client secret, which causes this error).";
                } else if (error.errorCode === "popup_window_error") {
                    title = "Popup Blocked";
                    solution = "Your browser blocked the login popup. Please allow popups for this site.";
                }

                showError(title, msg, solution);
                document.getElementById('auth-status').innerText = "Login failed.";
            }
        }

        function showError(title, details, solution = "") {
            const box = document.getElementById('auth-error-details');
            box.style.display = 'block';
            box.innerHTML = `
                <span class="error-title">${title}</span>
                ${details}
                ${solution ? `<br><br><strong>Suggested Fix:</strong><br>${solution}` : ""}
            `;
        }

        function handleResponse(response) {
            if (response !== null) {
                accessToken = response.accessToken;
                updateUIForUser(response.account);
                document.getElementById('auth-error-details').style.display = 'none';
            }
        }

        function signOut() {
            const logoutRequest = { account: myMSALObj.getAllAccounts()[0] };
            myMSALObj.logoutPopup(logoutRequest);
            accessToken = null;
            updateUIForUser(null);
        }

        function updateUIForUser(account) {
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const authStatus = document.getElementById('auth-status');

            if (account) {
                signInButton.style.display = 'none';
                signOutButton.style.display = 'block';
                authStatus.innerText = `Signed in as: ${account.name}`;
                authStatus.style.color = 'green';
                checkFilesStatus();
            } else {
                signInButton.style.display = 'block';
                signOutButton.style.display = 'none';
                authStatus.innerText = "";
            }
        }

        // --- FILE & LOGIC (Standard) ---
        let allOrdersData = null;
        let sdsFiles = [];
        let processedOrders = [];
        let currentManualSdsResults = [];
        let debounceTimer;

        document.getElementById('ordersFile').addEventListener('change', (e) => handleOrdersFile(e.target.files));
        document.getElementById('sdsFolder').addEventListener('change', (e) => handleSdsFolder(e.target.files));
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => filterByPO(e.target.value), 300);
        });

        function handleOrdersFile(files) {
            const file = files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('order')) || workbook.SheetNames[0];
                allOrdersData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                checkFilesStatus();
            };
            reader.readAsArrayBuffer(file);
        }

        function handleSdsFolder(files) {
            sdsFiles = [];
            for (const file of files) {
                if (file.name.toLowerCase().endsWith('.pdf')) sdsFiles.push(file); 
            }
            sdsFiles.sort((a, b) => a.webkitRelativePath.localeCompare(b.webkitRelativePath));
            checkFilesStatus();
        }

        function checkFilesStatus() {
            const button = document.getElementById('processButton');
            if (allOrdersData && sdsFiles.length > 0 && accessToken) {
                button.disabled = false;
                button.className = 'button-ready';
            } else {
                button.disabled = true;
                button.className = 'button-disabled';
            }
        }
        
        // --- HELPER FUNCTIONS ---
        function getValueCaseInsensitive(obj, ...keys) {
            for (const key of keys) {
                const lowerKey = key.toLowerCase().trim();
                for (const objKey in obj) {
                    if (objKey.toLowerCase().trim() === lowerKey) return obj[objKey];
                }
            }
            return undefined;
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date)) return 'N/A';
            return date.toISOString().split('T')[0];
        }
        
        function normalizeString(str) { return str.toLowerCase().replace(/[\s-_]/g, ''); }

        function cleanDescription(description) {
            if (!description) return "";
            return description.split(/[\d]+(ml|oz|g|kg|l|liter)/i)[0].trim(); // Simplified cleaner for debug
        }

        // --- MATCHING LOGIC ---
        function findSdsMatch(desc, country, files) {
            if (!desc || !files.length) return null;
            const normalizedDesc = normalizeString(cleanDescription(desc));
            return files.find(f => normalizeString(f.name).includes(normalizedDesc)) || null;
        }

        // --- UI GENERATION ---
        function processFiles() {
            const tableBody = allOrdersData.slice(0, 50).map((order, i) => {
                const desc = getValueCaseInsensitive(order, 'Description');
                const match = findSdsMatch(desc, 'NL', sdsFiles);
                return `<tr>
                    <td>${formatDate(getValueCaseInsensitive(order, 'Order Date'))}</td>
                    <td>${getValueCaseInsensitive(order, 'Customer PO')}</td>
                    <td>${desc}</td>
                    <td class="${match ? 'sds-match' : 'sds-no-match'}">${match ? match.name : 'No Match'}</td>
                    <td><button onclick="alert('Email feature disabled in debug mode until login is fixed')">Send Email</button></td>
                </tr>`;
            }).join('');
            
            document.getElementById('results-container').innerHTML = 
                `<table><thead><tr><th>Date</th><th>PO</th><th>Desc</th><th>SDS</th><th>Action</th></tr></thead><tbody>${tableBody}</tbody></table>`;
        }

    </script>
</body>
</html>
