<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDS Email Assistant (MS Graph API Version)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Using MSAL 2.x -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 2em; background-color: #f8f9fa; color: #212529; font-size: 14px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; padding: 2em; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5em; text-align: center; }
        .file-upload-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .file-input-box { padding: 20px; border: 2px dashed #ced4da; border-radius: 8px; background-color: #f8f9fa; text-align: center; }
        .file-input-box label { font-weight: bold; margin-bottom: 5px; display: block; font-size: 1.1em; }
        input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin-top: 10px; }
        #search-container { margin-bottom: 20px; }
        #searchInput { width: 100%; padding: 10px; font-size: 1em; border: 1px solid #ced4da; border-radius: 5px; }
        button { display: block; width: 100%; padding: 12px; font-size: 1em; font-weight: bold; cursor: pointer; color: white; border: none; border-radius: 5px; transition: background-color 0.3s; margin-top: 10px; }
        .button-disabled { background-color: #6c757d; cursor: not-allowed; }
        .button-ready { background-color: #28a745; }
        .button-primary { background-color: #007bff; }
        .button-primary:hover { background-color: #0056b3; }
        .button-ready:hover { background-color: #218838; }
        #results-container { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        th, td { border: 1px solid #dee2e6; text-align: left; padding: 8px; vertical-align: top; word-break: break-word; font-size: 12px; }
        th { background-color: #e9ecef; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .status { font-style: italic; color: #6c757d; text-align: center; padding: 1em; }
        .sds-match { color: #28a745; font-weight: bold; }
        .sds-no-match { color: #dc3545; }
        .processed-row { background-color: #d4edda; color: #155724; }
        #log-container { width: 100%; max-width: 1200px; margin-top: 20px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #ffffff; }
        #log-area { height: 150px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ced4da; padding: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .footer { margin-top: 2em; text-align: center; color: #6c757d; font-size: 0.9em; }

        /* Error Box Styles */
        .error-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
            font-size: 13px;
            text-align: left;
            white-space: pre-line; /* Handle newlines nicely */
        }
        .error-title { font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 5px; }

        .sds-search-container { position: relative; }
        .sds-search-container input { width: 100%; box-sizing: border-box; }
        .sds-results { display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background-color: white; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sds-results div { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 11px; color: #212529; }
        .sds-results div:hover { background-color: #e9ecef; }
        .sds-results div:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>SDS Email Assistant</h1>
        <p>This tool helps find matching SDS files for your orders and sends them via email. You must be signed in to send emails. Use the search box to find any order by Customer PO.</p>

        <div id="auth-container">
            <button id="signInButton" onclick="signIn()" class="button-primary">Sign In with Microsoft</button>
            <button id="signOutButton" onclick="signOut()" class="button-primary" style="display: none;">Sign Out</button>
            <p id="auth-status" class="status"></p>
            <div id="auth-error-details" class="error-box"></div>
        </div>

        <div class="file-upload-area">
            <div class="file-input-box">
                <label for="ordersFile">1. Select Order History File</label>
                <input type="file" id="ordersFile" accept=".xls,.xlsx">
            </div>
            <div class="file-input-box">
                <label for="sdsFolder">2. Select SDS PDF Folder</label>
                <input type="file" id="sdsFolder" webkitdirectory directory multiple>
            </div>
        </div>

        <div id="search-container">
            <input type="text" id="searchInput" placeholder="Search by Customer PO...">
        </div>

        <button id="processButton" onclick="processFiles()" disabled class="button-disabled">Process Files</button>
        
        <div id="results-container">
            <p class="status">Please sign in and select your files to begin.</p>
        </div>
    </div>

    <div id="log-container" style="display: none;">
        <h2>Activity Log</h2>
        <div id="log-area"></div>
        <button onclick="downloadLog()" style="margin-top: 10px; width: auto; padding: 8px 12px; font-size: 0.9em;">Download Log</button>
        <div style="margin-top: 10px;">
            <input type="checkbox" id="showProcessedCheckbox" onchange="toggleProcessedOrders()">
            <label for="showProcessedCheckbox">Show Processed Orders</label>
        </div>
    </div>

    <div class="footer">
        <p>ADDEV Materials Aerospace B.V.</p>
    </div>

    <script>
       // --- START: MSAL CONFIGURATION ---
        const msalConfig = {
            auth: {
                clientId: "8526bd2d-d28b-46c2-8b26-69887f97e0bf",
                // This authority is for a SPECIFIC Tenant (Single Tenant)
                // Only users IN this organization can login. Personal MS accounts will fail.
                authority: "https://login.microsoftonline.com/3eb0a4e0-e392-46c7-82db-984db1de22f8", 
                
                // Redirect URI Validation:
                // If running on GitHub, uses the hardcoded GitHub URL.
                // If running locally, you might want to switch this to your localhost URL.
                redirectUri: "https://nielsheins76-maker.github.io/Sales-email/", 
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            }
        };

        const graphScopes = ["user.read", "mail.send"];
        let myMSALObj;
        let accessToken = null;

        // Initialize MSAL
        try {
            myMSALObj = new msal.PublicClientApplication(msalConfig);
        } catch (e) {
            document.getElementById('auth-error-details').style.display = 'block';
            document.getElementById('auth-error-details').innerText = "Critical Error Initializing MSAL: " + e.message;
            console.error(e);
        }
        
        let allOrdersData = null;
        let sdsFiles = [];
        let emailLog = [];
        let processedOrders = [];
        let currentManualSdsResults = [];
        let debounceTimer;

        // Event Listeners
        document.getElementById('ordersFile').addEventListener('change', (e) => handleOrdersFile(e.target.files));
        document.getElementById('sdsFolder').addEventListener('change', (e) => handleSdsFolder(e.target.files));
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => filterByPO(e.target.value), 300);
        });

        // --- AUTHENTICATION ---
        async function signIn() {
            const errorBox = document.getElementById('auth-error-details');
            errorBox.style.display = 'none';
            errorBox.innerText = '';
            
            const loginRequest = { scopes: graphScopes };

            try {
                // Try popup login
                const loginResponse = await myMSALObj.loginPopup(loginRequest);
                handleResponse(loginResponse);
            } catch (error) {
                console.error("Login failed:", error);
                
                let errorTitle = "Authentication Failed";
                let errorMessage = "";
                
                // --- ERROR DIAGNOSIS ---
                
                // 1. Redirect URI Mismatch (Common on GitHub/Localhost)
                if (error.errorCode === "redirect_uri_mismatch" || (error.message && error.message.includes("AADSTS50011"))) {
                    errorTitle = "Configuration Mismatch (Redirect URI)";
                    errorMessage = `The URL in your code does not match the URL registered in Azure.
                    
                    Expected by Code: ${msalConfig.auth.redirectUri}
                    Current Browser URL: ${window.location.href}
                    
                    Fix: Ensure the 'redirectUri' in the code matches exactly what is in the Azure Portal (including http/https and trailing slashes).`;
                } 
                // 2. Tenant Mismatch (Wrong Account Type)
                else if (error.message && error.message.includes("AADSTS50020")) {
                    errorTitle = "Wrong Account Type (Tenant Error)";
                    errorMessage = `You are trying to sign in with an account that does not belong to this organization.
                    
                    Your app is configured as "Single Tenant" (ID: 3eb0a4e0...).
                    - You CANNOT use personal accounts (outlook.com, hotmail.com).
                    - You CANNOT use accounts from other companies unless added as a Guest.
                    
                    Fix: Sign in with your corporate 'ADDEV Materials' account.`;
                }
                // 3. Popup Blocked
                else if (error.name === "BrowserAuthError" && error.errorCode === "popup_window_error") {
                    errorTitle = "Popup Blocked";
                    errorMessage = "The login popup was blocked by your browser. Please look for the 'Popup Blocked' icon in your address bar and allow popups for this site.";
                } 
                // 4. Generic Fallback
                else {
                    errorMessage = error.message || JSON.stringify(error);
                }

                document.getElementById('auth-status').innerText = "Login failed.";
                errorBox.style.display = 'block';
                errorBox.innerHTML = `<span class="error-title">${errorTitle}</span>${errorMessage}`;
            }
        }

        function handleResponse(response) {
            if (response !== null) {
                accessToken = response.accessToken;
                console.log("Sign-in successful. Access token acquired.");
                updateUIForUser(response.account);
                document.getElementById('auth-error-details').style.display = 'none';
            }
        }

        function signOut() {
            const logoutRequest = {
                account: myMSALObj.getAccountByHomeId(myMSALObj.getAllAccounts()[0].homeAccountId)
            };
            myMSALObj.logoutPopup(logoutRequest);
            accessToken = null;
            updateUIForUser(null);
        }

        function updateUIForUser(account) {
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const authStatus = document.getElementById('auth-status');

            if (account) {
                signInButton.style.display = 'none';
                signOutButton.style.display = 'block';
                authStatus.innerText = `Signed in as: ${account.name} (${account.username})`;
                authStatus.style.color = '#28a745';
            } else {
                signInButton.style.display = 'block';
                signOutButton.style.display = 'none';
                authStatus.innerText = "";
                authStatus.style.color = '#6c757d';
            }
            checkFilesStatus();
        }


        // --- FILE HANDLING ---
        function handleOrdersFile(files) {
            const file = files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    // Try to find the correct sheet
                    let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('order')) || workbook.SheetNames[0];
                    allOrdersData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    console.log(`Loaded ${allOrdersData.length} total orders from sheet: ${sheetName}`);
                    
                    if (allOrdersData.length > 0) {
                        console.log("Detected column headers:", Object.keys(allOrdersData[0]));
                    }
                    checkFilesStatus();
                } catch (err) {
                    alert("Error reading Excel file: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleSdsFolder(files) {
            sdsFiles = [];
            for (const file of files) {
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    sdsFiles.push(file); 
                }
            }
            sdsFiles.sort((a, b) => a.webkitRelativePath.localeCompare(b.webkitRelativePath));
            console.log(`${sdsFiles.length} SDS PDF files loaded.`);
            checkFilesStatus();
        }

        function checkFilesStatus() {
            const button = document.getElementById('processButton');
            const statusContainer = document.querySelector('#results-container .status');
            
            // Allow processing even without login (just disable sending emails later), 
            // OR enforce login now. The original code enforced login to process.
            if (allOrdersData && sdsFiles.length > 0) {
                 if (accessToken) {
                    button.disabled = false;
                    button.className = 'button-ready';
                    button.innerText = "Process Files";
                 } else {
                    button.disabled = true;
                    button.className = 'button-disabled';
                    button.innerText = "Sign In Required to Process";
                 }
            } else {
                button.disabled = true;
                button.className = 'button-disabled';
                if(!allOrdersData && sdsFiles.length === 0) button.innerText = "Select Files to Begin";
                else if(!allOrdersData) button.innerText = "Select Order File";
                else button.innerText = "Select SDS Folder";
            }
        }


        // --- CORE LOGIC (SDS Matching) ---
        function normalizeString(str) { return str.toLowerCase().replace(/[\s-_]/g, ''); }

        function cleanDescription(description) {
            if (typeof description !== 'string' || !description) return "";
            const packagingTerms = [
                "fles 10ml", "release agent spray 12 oz", "can", "bottle", "quart", "tube", "1 gram", "fles",
                "40 ml. Applicator Pen", "Jerry", "cart 750ml", "Spatulas box 100x3.5gr", "500 gram", "5 liter",
                "roll 36\" x 100 yd unbleached", "Tin 1 Kg", "Dyed - (#004675) 12 oz", "cartridge", "2 gallon",
                "resin clear 1 liter", "pint", "6 oz (3.5 oz fill)", "Corrosion Resist Sealant 500 ml kit",
                "1/2 inch", "400 ml", "gallon", "10kg", "2 Oz Touch up Kit", "25 liter", "pouch 100 wipes", "6 oz",
                "thinner 0,5 liter", "Activator 1 liter", "Epoxy Primer 4 liter", "155kg drum", "kit", "drum", "pail",
                "roll", "oz", "ml", "liter", "gram", "spray", "aerosol", "wipes", "pen", "bag", "box", "kit"
            ];
            const pattern = new RegExp(`\\s*(${packagingTerms.join('|')}).*`, 'i');
            let cleaned = description.replace(pattern, '');
            cleaned = cleaned.replace(/[\/\-_,]+$/, '').trim();
            return cleaned;
        }
        
        function extractVersionNumber(filename) {
            const match = filename.match(/_V(\d+)/i);
            return match ? parseInt(match[1], 10) : 0;
        }
        
        async function getCountryCodeFromGeoNames(placeName) {
            if (!placeName || typeof placeName !== 'string') return null;
            const lowerPlaceName = placeName.toLowerCase();
            // Hardcoded exceptions
            if (lowerPlaceName.includes('schimatari viotias')) return 'GR';
            if (lowerPlaceName.includes('sigonella')) return 'IT';
            if (lowerPlaceName.includes('schiphol oost')) return 'NL';
            if (lowerPlaceName.includes('dubai airport freezone')) return 'AE';
            if (lowerPlaceName.includes('kahramankaza')) return 'TR';
            
            const cleanedPlaceName = placeName.split(',')[0].trim();
            // NOTE: This public username 'nielssecoa.nl' might hit rate limits. 
            // If it fails, we just return null and fallback to defaults.
            const url = `https://secure.geonames.org/searchJSON?q=${encodeURIComponent(cleanedPlaceName)}&maxRows=1&username=nielssecoa.nl`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                if (data.geonames && data.geonames.length > 0) {
                    return data.geonames[0].countryCode;
                }
                return null;
            } catch (error) {
                console.warn("GeoNames API check failed (non-critical):", error);
                return null;
            }
        }
        
        function getFormattedLandcode(countryCode) {
            if (!countryCode) return 'N/A';
            const code = countryCode.toUpperCase();
            const euCountries = new Set(["AT", "BE", "BG", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GR", "HR", "HU", "IE", "IT", "LT", "LU", "LV", "MT", "NL", "PL", "PT", "RO", "SE", "SI", "SK"]);
            return euCountries.has(code) ? `EU ${code}` : code;
        }

        function findSdsMatch(originalDesc, countryCode, sdsFileList) {
            if (!sdsFileList || sdsFileList.length === 0 || !originalDesc) return null;
            
            const cleanedDesc = cleanDescription(originalDesc);
            const normalizedDesc = normalizeString(cleanedDesc);
            
            if (!normalizedDesc) return null;

            const lowerCountryCode = countryCode ? countryCode.toLowerCase() : '';

            // 1. Direct match on filename
            let productMatches = sdsFileList.filter(file => {
                return normalizeString(file.name).includes(normalizedDesc);
            });
            
            // 2. Loose match (if no direct match)
            if (productMatches.length === 0) {
                productMatches = sdsFileList.filter(file => {
                    const filename = file.name.toLowerCase();
                    let baseName = filename
                        .replace(/\.pdf$/, '')
                        .replace(/_v\d+/, '')
                        .replace(/_(complete|eu|en|nl|de|fr|es|it|gr|tr|ae)_/g, '_')
                        .replace(/ (complete|eu|en|nl|de|fr|es|it|gr|tr|ae) /g, ' ');
                    baseName = normalizeString(baseName);
                    if (baseName.length < 6) return false;
                    return normalizedDesc.includes(baseName);
                });
            }

            if (productMatches.length === 0) return null;

            // 3. Filter by country code
            let potentialMatches = [];
            if (lowerCountryCode) {
                const countryMatches = productMatches.filter(file => {
                    const filename = file.name.toLowerCase();
                    return filename.includes(` ${lowerCountryCode} `) || filename.includes(`_${lowerCountryCode}_`);
                });
                if (countryMatches.length > 0) potentialMatches = countryMatches;
            }
            
            // 4. Fallback Logic (BE -> NL, then EN)
            if (potentialMatches.length === 0) {
                if (lowerCountryCode === 'be') {
                    const nlMatches = productMatches.filter(file => {
                        const filename = file.name.toLowerCase();
                        return filename.includes(' nl ') || filename.includes('_nl_');
                    });
                    if (nlMatches.length > 0) potentialMatches = nlMatches;
                }

                if (potentialMatches.length === 0) {
                    const enMatches = productMatches.filter(file => {
                        const filename = file.name.toLowerCase();
                        return filename.includes(' en ') || filename.includes('_en_');
                    });
                    potentialMatches = enMatches.length > 0 ? enMatches : productMatches;
                }
            }

            // 5. Select best match (latest version or 'complete')
            if (potentialMatches.length > 1) {
                const completeMatch = potentialMatches.find(file => 
                    file.webkitRelativePath.toLowerCase().includes('complete')
                );
                if (completeMatch) return completeMatch;
                
                potentialMatches.sort((a, b) => extractVersionNumber(b.name) - extractVersionNumber(a.name));
            }
            
            return potentialMatches[0] || null;
        }

        // --- EMAIL GENERATION & SENDING ---
        async function sendEmail(index) {
            const order = processedOrders[index];
            if (!order.toEmail) {
                alert('Cannot send email: "To Email" field is empty.');
                return;
            }
            if (!order.sdsMatch) {
                alert('Cannot send email: No SDS file is matched for this order.');
                return;
            }

            const button = document.querySelector(`#results-container tr:nth-child(${index + 1}) button`);
            const originalText = button.innerText;
            button.disabled = true;
            button.innerText = 'Sending...';

            const to = order.toEmail;
            const cc = order.ccEmail;
            const subject = `PO# ${order.subject}`;
            const body = [
                "Dear customer,",
                "\n",
                "Please find the relevant document(s) for your recent order.",
                "\n",
                "Order Details:",
                `- Your PO#: ${order.subject}`,
                `- Product: ${order.description}`,
                `- Our Order#: ${order.orderNumber}`,
                "\n",
                "If there are any questions regarding this email or its content, please reply to this e-mail or send a",
                "e-mail to hse.nl@addevmaterials.com",
                "\n",
                "With kind regards,",
                "ADDEV Materials Aerospace B.V.",
                "Bunsenstraat 21, 3316 GC, Dordrecht, The Netherlands."
            ].join('\n');

            try {
                await sendEmailWithAttachmentViaGraphAPI(to, cc, subject, body, order.sdsMatch);

                const timestamp = new Date().toLocaleString();
                emailLog.push(`${timestamp} - Email sent to: ${to} for PO# ${order.subject} with attachment: ${order.sdsMatch.name}`);
                updateLogView();

                // Save to localStorage
                const orderKey = `${order.orderNumber}|${order.subject}`;
                let processed = new Set(JSON.parse(localStorage.getItem('processedOrders')) || []);
                processed.add(orderKey);
                localStorage.setItem('processedOrders', JSON.stringify([...processed]));

                const tableRow = document.querySelector(`#results-container tbody tr:nth-child(${index + 1})`);
                if (tableRow) {
                    tableRow.classList.add('processed-row');
                    button.innerText = 'Sent';
                }

            } catch (error) {
                console.error("Failed to send email:", error);
                // Handle specific Token expired errors
                if (error.message.includes("Access token is empty") || error.statusCode === 401) {
                     alert("Your session has expired. Please sign out and sign in again.");
                } else {
                     alert(`Failed to send email: ${error.message}`);
                }
                button.disabled = false;
                button.innerText = originalText;
            }
        }

        async function sendEmailWithAttachmentViaGraphAPI(to, cc, subject, body, attachmentFile) {
            if (!accessToken) throw new Error("Access token is empty. Please sign in.");

            const endpoint = "https://graph.microsoft.com/v1.0/me/sendMail";

            const reader = new FileReader();
            const fileAsBase64 = await new Promise((resolve, reject) => {
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(attachmentFile);
            });
            
            const emailMessage = {
                message: {
                    subject: subject,
                    body: {
                        contentType: "text",
                        content: body
                    },
                    toRecipients: [{ emailAddress: { address: to } }],
                    attachments: [
                        {
                            "@odata.type": "#microsoft.graph.fileAttachment",
                            "name": attachmentFile.name,
                            "contentType": attachmentFile.type || "application/pdf",
                            "contentBytes": fileAsBase64
                        }
                    ]
                }
            };

            if (cc) {
                emailMessage.message.ccRecipients = [{ emailAddress: { address: cc } }];
            }

            const response = await fetch(endpoint, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(emailMessage)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Graph API Error Details:", errorData);
                throw new Error(errorData.error ? errorData.error.message : response.statusText);
            }
            console.log("Email sent successfully via Graph API.");
        }


        // --- DISPLAY AND UI LOGIC ---
        function filterSds(event, orderIndex) {
            const searchTerm = event.target.value.toLowerCase();
            const resultsContainer = document.getElementById(`sds-results-${orderIndex}`);
            if (searchTerm.length < 3) {
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'none';
                return;
            }
            
            currentManualSdsResults = sdsFiles.filter(file => 
                file.webkitRelativePath.toLowerCase().includes(searchTerm)
            ).slice(0, 15);

            if (currentManualSdsResults.length === 0) {
                resultsContainer.innerHTML = '<div>No files found</div>';
            } else {
                resultsContainer.innerHTML = currentManualSdsResults.map((file, fileIndex) => 
                    `<div onclick='selectSds(${fileIndex}, ${orderIndex})'>${file.name} (..${file.webkitRelativePath.slice(-50)})</div>`
                ).join('');
            }
            resultsContainer.style.display = 'block';
        }

        function selectSds(fileIndex, orderIndex) {
            const selectedFile = currentManualSdsResults[fileIndex];
            if (!selectedFile) return;

            processedOrders[orderIndex].sdsMatch = selectedFile;
            
            const tableRow = document.querySelector(`#results-container tbody tr:nth-child(${orderIndex + 1})`);
            const matchCell = tableRow.children[5]; // Column 5
            matchCell.innerHTML = selectedFile.name;
            matchCell.className = 'sds-match';

            const button = tableRow.querySelector('button');
            button.disabled = false;

            document.getElementById(`sds-results-${orderIndex}`).style.display = 'none';
        }

        async function displayResults(ordersToProcess) {
            const container = document.getElementById('results-container');
            container.innerHTML = `<p class="status" id="progress-status">Processing ${ordersToProcess.length} orders...</p>`;
            
            const tableHeader = `<thead><tr><th>Date</th><th>Subject (PO)</th><th>Description</th><th>Ship To</th><th>Landcode</th><th>Matching SDS PDF</th><th>To Email</th><th>CC Email</th><th>Action</th></tr></thead>`;
            let tableBody = '';
            processedOrders = []; 
            const totalOrders = ordersToProcess.length;

            for (let i = 0; i < totalOrders; i++) {
                if (i % 10 === 0) {
                    document.getElementById('progress-status').innerText = `Processing... ${i + 1} of ${totalOrders} complete.`;
                }

                const order = ordersToProcess[i];
                const shipTo = getValueCaseInsensitive(order, 'Ship To') || 'N/A';

                let sdsEmail = (getValueCaseInsensitive(order, 'SDS Email') || '').toString().trim();
                let buyerEmail = (getValueCaseInsensitive(order, 'Buyer Email') || '').toString().trim();
                let toEmail = sdsEmail;
                let ccEmail = buyerEmail;
                if (!toEmail && buyerEmail) {
                    toEmail = buyerEmail;
                    ccEmail = '';
                }

                const countryCode = await getCountryCodeFromGeoNames(shipTo);
                const landcode = getFormattedLandcode(countryCode);
                const description = getValueCaseInsensitive(order, 'Description') || '';
                
                const sdsMatch = findSdsMatch(description, countryCode, sdsFiles);

                const orderData = {
                    date: formatDate(getValueCaseInsensitive(order, 'Originally Promised', 'Order Date')),
                    subject: getValueCaseInsensitive(order, 'Customer PO') || 'N/A',
                    description: description,
                    shipTo: shipTo,
                    landcode: landcode,
                    toEmail: toEmail,
                    ccEmail: ccEmail,
                    orderNumber: getValueCaseInsensitive(order, 'Order Number') || 'N/A',
                    sdsMatch: sdsMatch 
                };
                processedOrders.push(orderData);

                let matchCell;
                if (sdsMatch) {
                    matchCell = `<td class="sds-match">${sdsMatch.name}</td>`;
                } else {
                    const searchInputHTML = `<div class="sds-search-container">
                        <input type="text" id="sds-search-${i}" onkeyup="filterSds(event, ${i})" placeholder="Search SDS..." autocomplete="off">
                        <div class="sds-results" id="sds-results-${i}"></div>
                    </div>`;
                    matchCell = `<td class="sds-no-match">${searchInputHTML}</td>`;
                }

                tableBody += `<tr>
                    <td>${orderData.date}</td>
                    <td>${orderData.subject}</td>
                    <td>${orderData.description}</td>
                    <td>${orderData.shipTo}</td>
                    <td>${orderData.landcode}</td> ${matchCell}
                    <td>${orderData.toEmail}</td>
                    <td>${orderData.ccEmail}</td>
                    <td><button onclick="sendEmail(${i})" ${!sdsMatch ? 'disabled' : ''}>Send Email</button></td>
                </tr>`;
            }

            container.innerHTML = `<table>${tableHeader}<tbody>${tableBody}</tbody></table>`;
        }

        function processFiles() {
            if (!allOrdersData || sdsFiles.length === 0) {
                alert("Please select both the Orders file and the SDS Folder first.");
                return;
            }
            const defaultOrders = getDefaultOrderList();
            displayResults(defaultOrders);
        }
        
        // --- UTILITY FUNCTIONS ---
        function getValueCaseInsensitive(obj, ...keys) {
            for (const key of keys) {
                const lowerKey = key.toLowerCase().trim();
                for (const objKey in obj) {
                    if (objKey.toLowerCase().trim() === lowerKey) return obj[objKey];
                }
            }
            return undefined;
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date)) return 'N/A';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getDefaultOrderList() {
            const showProcessed = document.getElementById('showProcessedCheckbox').checked;
            let ordersToFilter = allOrdersData;

            if (!showProcessed) {
                const processedKeys = new Set(JSON.parse(localStorage.getItem('processedOrders')) || []);
                ordersToFilter = allOrdersData.filter(order => {
                    const orderKey = `${getValueCaseInsensitive(order, 'Order Number')}|${getValueCaseInsensitive(order, 'Customer PO')}`;
                    return !processedKeys.has(orderKey);
                });
            }

            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            monday.setHours(0, 0, 0, 0);

            const upcomingOrders = ordersToFilter.filter(order => {
                const promisedDate = getValueCaseInsensitive(order, 'Originally Promised');
                return promisedDate instanceof Date && promisedDate >= monday;
            });

            upcomingOrders.sort((a, b) => {
                const dateA = getValueCaseInsensitive(a, 'Originally Promised');
                const dateB = getValueCaseInsensitive(b, 'Originally Promised');
                return dateA - dateB;
            });

            return upcomingOrders.slice(0, 100);
        }

        function toggleProcessedOrders() {
            filterByPO(document.getElementById('searchInput').value);
        }

        function filterByPO(searchTerm) {
            if (!allOrdersData) return;
            const lowerSearchTerm = searchTerm.toLowerCase();

            const filteredOrders = lowerSearchTerm 
                ? allOrdersData.filter(order => {
                    const po = getValueCaseInsensitive(order, 'Customer PO') || '';
                    return po.toString().toLowerCase().includes(lowerSearchTerm);
                  })
                : getDefaultOrderList();

            displayResults(filteredOrders); 
        }
        
        function updateLogView() {
            document.getElementById('log-container').style.display = 'block';
            document.getElementById('log-area').textContent = emailLog.join('\n');
            document.getElementById('log-area').scrollTop = document.getElementById('log-area').scrollHeight;
        }
        
        function downloadLog() {
            const logContent = emailLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sds_email_log_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Try to check for existing session on load
        if(myMSALObj) {
            const currentAccounts = myMSALObj.getAllAccounts();
            if (currentAccounts.length > 0) {
                myMSALObj.setActiveAccount(currentAccounts[0]);
                updateUIForUser(currentAccounts[0]);
            }
        }
    </script>
</body>
</html>
